---
- name: Install basic apt packages
  ansible.builtin.apt:
    update_cache: true
    name: "{{ basic_packages }}"
    state: present

- name: Install neovim dependencies
  ansible.builtin.package:
    name: "{{ neovim_dependencies }}"
    state: present

- name: Install python3 and pip
  ansible.builtin.package:
    name:
      - python3
      - python3-pip
    state: latest

- name: Check if yq is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/yq
  register: yq_binary

- name: Download and install yq (YAML processor)
  when: not yq_binary.stat.exists
  block:
    - name: Download yq binary
      ansible.builtin.get_url:
        url: https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        dest: /usr/local/bin/yq
        mode: '0755'
        owner: root
        group: root

    - name: Verify yq installation
      ansible.builtin.command: yq --version
      register: yq_version
      changed_when: false

    - name: Display yq version
      ansible.builtin.debug:
        msg: "yq installed: {{ yq_version.stdout }}"

- name: Install Doppler CLI prerequisites
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present
    update_cache: true

- name: Check if Doppler CLI is already installed
  ansible.builtin.command: which doppler
  register: doppler_check
  changed_when: false
  failed_when: false

- name: Install Doppler CLI using official install script
  when: doppler_check.rc != 0
  ansible.builtin.shell: |
    (curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh || \
     wget -t 3 -qO- https://cli.doppler.com/install.sh) | sh
  args:
    executable: /bin/bash
  changed_when: true

- name: Verify Doppler installation
  ansible.builtin.command: doppler --version
  register: doppler_version
  changed_when: false

- name: Display Doppler version
  ansible.builtin.debug:
    msg: "Doppler CLI installed: {{ doppler_version.stdout }}"
