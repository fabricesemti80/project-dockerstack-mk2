---
- name: Gather disk information
  ansible.builtin.setup:
    gather_subset:
      - hardware

- name: Find unpartitioned data disks
  ansible.builtin.set_fact:
    data_disks: "{{ ansible_facts['devices'] | dict2items | selectattr('key', 'match', '^sd[a-z]$|^nvme[0-9]+n[0-9]+$|^xvd[a-z]$') | rejectattr('key', 'equalto', 'vda') | selectattr('value.partitions', 'equalto', {}) | map(attribute='key') | list }}"

- name: Set skip flag if no disks found
  ansible.builtin.set_fact:
    skip_storage_setup: "{{ data_disks | length == 0 }}"

- name: LVM Setup Block
  when: not skip_storage_setup
  block:
    - name: Select the largest available disk
      ansible.builtin.set_fact:
        selected_data_disk_name: "{{ data_disks[0] }}"

    - name: Check if volume group exists
      ansible.builtin.shell: "vgdisplay {{ lvm_volume_group_name }} || true"
      register: vg_exists
      changed_when: false

    - name: Check if logical volume exists
      ansible.builtin.shell: "lvdisplay /dev/{{ lvm_volume_group_name }}/{{ lvm_data_volume_name }} || true"
      register: lv_exists
      changed_when: false

    - name: Create physical volume and volume group
      community.general.lvg:
        vg: "{{ lvm_volume_group_name }}"
        pvs: "/dev/{{ selected_data_disk_name }}"
        state: present
      when: "'not found' in vg_exists.stdout or vg_exists.rc != 0"

    - name: Create logical volume for data
      community.general.lvol:
        vg: "{{ lvm_volume_group_name }}"
        lv: "{{ lvm_data_volume_name }}"
        size: "{{ lvm_data_volume_size }}"
        state: present
      when: "'not found' in lv_exists.stdout or lv_exists.rc != 0"

    - name: Check if filesystem exists
      ansible.builtin.shell: "blkid /dev/{{ lvm_volume_group_name }}/{{ lvm_data_volume_name }} || true"
      register: fs_exists
      changed_when: false

    - name: Create filesystem
      community.general.filesystem:
        fstype: "{{ data_filesystem }}"
        dev: "/dev/{{ lvm_volume_group_name }}/{{ lvm_data_volume_name }}"
        state: present
      when: fs_exists.stdout == ""

    - name: Create mount point directory
      ansible.builtin.file:
        path: "{{ data_mount_point }}"
        state: directory
        mode: '0755'

    - name: Mount the logical volume
      ansible.posix.mount:
        path: "{{ data_mount_point }}"
        src: "/dev/{{ lvm_volume_group_name }}/{{ lvm_data_volume_name }}"
        fstype: "{{ data_filesystem }}"
        opts: "{{ data_mount_options }}"
        state: mounted

    - name: Set proper ownership for /data
      ansible.builtin.file:
        path: "{{ data_mount_point }}"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0755'
        recurse: false