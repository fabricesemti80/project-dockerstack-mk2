---
- name: Ensure nfs-common is installed
  ansible.builtin.apt:
    name: nfs-common
    state: present

- name: Create media mount point
  ansible.builtin.file:
    path: "{{ nfs_mount_point }}"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'

- name: Mount NFS share for media
  ansible.posix.mount:
    path: "{{ nfs_mount_point }}"
    src: "{{ nfs_share_server }}:{{ nfs_share_path }}"
    fstype: nfs
    opts: defaults,soft,intr,rsize=8192,wsize=8192
    state: mounted
  register: nfs_mount_result

- name: Display NFS mount status
  ansible.builtin.debug:
    msg: "NFS share {{ nfs_share_server }}:{{ nfs_share_path }} mounted on {{ nfs_mount_point }}"
  when: nfs_mount_result is changed

- name: Create download directories inside media mount
  ansible.builtin.file:
    path: "{{ nfs_mount_point }}/{{ item }}"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0775'
  loop:
    - "torrents"
    - "usenet"
  tags: [nfs, media, downloads]

- name: Create README files for download directories
  ansible.builtin.copy:
    content: |
      # {{ item | title }}

      {{ 'BitTorrent downloads' if item == 'torrents' else 'Usenet downloads' }}

      Created by: Ansible homelab setup
      Storage: NFS Share ({{ nfs_share_server }})
      Owner: {{ admin_user }}

      Directory managed by Ansible.
    dest: "{{ nfs_mount_point }}/{{ item }}/README.md"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0644'
  loop:
    - "torrents"
    - "usenet"
  tags: [nfs, media, downloads]

- name: Create .gitkeep files in download directories
  ansible.builtin.copy:
    content: ""
    dest: "{{ nfs_mount_point }}/{{ item }}/.gitkeep"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0644'
  loop:
    - "torrents"
    - "usenet"
  tags: [nfs, media, downloads]
