---
- name: Check status of homelab paths
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "/data/homelab"
    - "/data/media"
    - "/data/torrents"
    - "/data/usenet"
  register: homelab_paths_stat

- name: Remove files/links blocking homelab directories
  ansible.builtin.file:
    path: "{{ item.item }}"
    state: absent
  loop: "{{ homelab_paths_stat.results }}"
  when: item.stat.exists and (item.stat.isreg or item.stat.islnk)
  loop_control:
    label: "{{ item.item }}"

- name: Create homelab directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'
  loop:
    - "/data/homelab"
    - "/data/media"
    - "/data/torrents"
    - "/data/usenet"

- name: Set directory permissions (non-recursive for media)
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'
    recurse: "{{ 'false' if item == '/data/media' else 'true' }}"
  loop:
    - "/data/homelab"
    - "/data/media"
    - "/data/torrents"
    - "/data/usenet"

- name: Create README files for each directory
  ansible.builtin.copy:
    content: |
      # {{ item.name }}

      {{ item.description }}

      Created by: Ansible homelab setup
      Owner: {{ admin_user }}
      Permissions: {{ secondary_user }} has full access

      Directory structure managed by Ansible.
      Do not modify this file manually.
    dest: "{{ item.path }}/README.md"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0644'
  loop:
    - name: "Homelab Root"
      path: "/data/homelab"
      description: "Root directory for homelab services and configurations"
    - name: "Media Directory"
      path: "/data/media"
      description: "All media content (movies, TV shows, videos)"
    - name: "Torrents"
      path: "/data/torrents"
      description: "BitTorrent downloads and incomplete files"
    - name: "Usenet"
      path: "/data/usenet"
      description: "Usenet downloads and processing"
  # Don't write README into the media share if it's already mounted
  when: item.path != "/data/media"

- name: Create .gitkeep files
  ansible.builtin.copy:
    content: ""
    dest: "{{ item }}/.gitkeep"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0644'
  loop:
    - "/data/torrents"
    - "/data/usenet"

- name: Create Jellyfin directories on NFS
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: 1000
    group: 1000
    mode: '0755'
  loop:
    - "/data/media/config"
    - "/data/media/config/jellyfin"
    - "/data/media/config/jellyfin-cache"