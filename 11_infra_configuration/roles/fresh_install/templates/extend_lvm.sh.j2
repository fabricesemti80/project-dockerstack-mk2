#!/bin/bash
# LVM Extension Script for {{ lvm_volume_group_name }}
# Generated by Ansible

set -e

VG_NAME="{{ lvm_volume_group_name }}"
LV_NAME="{{ lvm_data_volume_name }}"
MOUNT_POINT="{{ data_mount_point }}"

function show_usage() {
    echo "Usage: $0 [add-disk|extend-lv|resize-fs|full-extend] [disk_path]"
    echo ""
    echo "Commands:"
    echo "  add-disk /dev/sdX    - Add a new disk to the volume group"
    echo "  extend-lv            - Extend logical volume to use all available space"
    echo "  resize-fs            - Resize filesystem to match logical volume"
    echo "  full-extend /dev/sdX - Complete process: add disk, extend LV, resize FS"
    echo "  status               - Show current LVM status"
    echo ""
    echo "Examples:"
    echo "  $0 add-disk /dev/sdb"
    echo "  $0 full-extend /dev/sdb"
    echo "  $0 status"
}

function check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "This script must be run as root"
        exit 1
    fi
}

function show_status() {
    echo "=== Current LVM Status ==="
    echo "Physical Volumes:"
    pvs
    echo ""
    echo "Volume Groups:"
    vgs
    echo ""
    echo "Logical Volumes:"
    lvs
    echo ""
    echo "Disk Usage:"
    df -h $MOUNT_POINT
}

function add_disk() {
    local disk_path="$1"

    if [[ -z "$disk_path" ]]; then
        echo "Error: Disk path required"
        show_usage
        exit 1
    fi

    if [[ ! -b "$disk_path" ]]; then
        echo "Error: $disk_path is not a valid block device"
        exit 1
    fi

    echo "Adding disk $disk_path to volume group $VG_NAME..."

    # Check if disk is already a PV
    if ! pvdisplay "$disk_path" >/dev/null 2>&1; then
        echo "Creating physical volume on $disk_path..."
        pvcreate "$disk_path"
    else
        echo "Physical volume already exists on $disk_path"
    fi

    # Check if disk is already in the VG
    if ! vgdisplay "$VG_NAME" | grep -q "$disk_path"; then
        echo "Extending volume group $VG_NAME with $disk_path..."
        vgextend "$VG_NAME" "$disk_path"
    else
        echo "$disk_path is already part of volume group $VG_NAME"
    fi

    echo "Successfully processed $disk_path for $VG_NAME"
    show_status
}

function extend_lv() {
    echo "Extending logical volume $LV_NAME to use all available space..."

    # Check if there's free space
    local free_space=$(vgdisplay "$VG_NAME" | grep "Free" | awk '{print $7}')

    if [[ "$free_space" == "0" ]]; then
        echo "No free space available in volume group $VG_NAME"
        return 1
    fi

    # Extend logical volume
    lvextend -l +100%FREE "/dev/$VG_NAME/$LV_NAME"

    echo "Successfully extended logical volume"
}

function resize_fs() {
    echo "Resizing filesystem on /dev/$VG_NAME/$LV_NAME..."

    # Check filesystem type
    local fs_type=$(blkid -o value -s TYPE "/dev/$VG_NAME/$LV_NAME")

    case "$fs_type" in
        ext2|ext3|ext4)
            resize2fs "/dev/$VG_NAME/$LV_NAME"
            ;;
        xfs)
            xfs_growfs "$MOUNT_POINT"
            ;;
        *)
            echo "Unsupported filesystem type: $fs_type"
            exit 1
            ;;
    esac

    echo "Successfully resized filesystem"
    df -h "$MOUNT_POINT"
}

function full_extend() {
    local disk_path="$1"

    echo "Performing full extension with disk $disk_path..."

    add_disk "$disk_path"
    extend_lv
    resize_fs

    echo "Full extension completed successfully!"
    show_status
}

# Main script logic
case "$1" in
    add-disk)
        check_root
        add_disk "$2"
        ;;
    extend-lv)
        check_root
        extend_lv
        ;;
    resize-fs)
        check_root
        resize_fs
        ;;
    full-extend)
        check_root
        full_extend "$2"
        ;;
    status)
        show_status
        ;;
    *)
        show_usage
        exit 1
        ;;
esac
