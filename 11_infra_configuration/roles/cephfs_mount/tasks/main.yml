---
- name: Verify Ceph secret is present
  ansible.builtin.fail:
    msg: "The 'cephfs_secret' variable is empty. Please ensure CEPH_SECRET_KEY is set in your environment or use the 'run.sh' script which handles secrets."
  when: cephfs_secret | length == 0
  tags: [cephfs, storage]

- name: Install ceph-common package
  ansible.builtin.apt:
    name: ceph-common
    state: present
  tags: [cephfs, storage]

- name: Create Ceph credential directory
  ansible.builtin.file:
    path: "/etc/ceph"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [cephfs, storage]

- name: Create Ceph configuration file
  ansible.builtin.template:
    src: ceph.conf.j2
    dest: "/etc/ceph/ceph.conf"
    owner: root
    group: root
    mode: '0644'
  tags: [cephfs, storage]

- name: Create Ceph admin secret file
  ansible.builtin.template:
    src: ceph_admin.secret.j2
    dest: "/etc/ceph/{{ cephfs_user }}.secret"
    owner: root
    group: root
    mode: '0600'
  no_log: true
  tags: [cephfs, storage]

- name: Create Ceph admin keyring
  ansible.builtin.template:
    src: ceph.client.admin.keyring.j2
    dest: "/etc/ceph/ceph.client.{{ cephfs_user }}.keyring"
    owner: "{{ admin_user }}"
    group: root
    mode: '0640'
  no_log: true
  tags: [cephfs, storage]

- name: Force lazy unmount of stale mount
  ansible.builtin.shell: "umount -l {{ cephfs_mount_point }}"
  become: true
  failed_when: false
  changed_when: false
  tags: [cephfs, storage]

- name: Create mount point directory
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'
  tags: [cephfs, storage]

- name: Check if CephFS is already mounted
  ansible.builtin.shell: "mountpoint -q {{ cephfs_mount_point }}"
  register: mount_check
  failed_when: false
  changed_when: false
  tags: [cephfs, storage]

- name: Mount CephFS
  ansible.posix.mount:
    path: "{{ cephfs_mount_point }}"
    src: "{{ cephfs_monitors }}:{{ cephfs_path }}"
    fstype: ceph
    opts: "{{ cephfs_mount_options }}"
    state: mounted
  when: mount_check.rc != 0
  tags: [cephfs, storage]

- name: Ensure CephFS is in fstab
  ansible.posix.mount:
    path: "{{ cephfs_mount_point }}"
    src: "{{ cephfs_monitors }}:{{ cephfs_path }}"
    fstype: ceph
    opts: "{{ cephfs_mount_options }}"
    state: present
  tags: [cephfs, storage]

- name: Set ownership on shared storage root
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}"
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'
    recurse: no
  tags: [cephfs, storage]

- name: Create application directories on shared storage
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/{{ item }}"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'
  loop: "{{ cephfs_app_dirs }}"
  tags: [cephfs, create_dirs, storage]

- name: Remove old Jellyfin directory from root
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/jellyfin"
    state: absent
  tags: [cephfs, cleanup, storage]

- name: Create app-specific directories in docker-data
  ansible.builtin.file:
    path: "{{ cephfs_mount_point }}/docker-data/{{ item }}"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0755'
  loop: "{{ cephfs_docker_data_dirs }}"
  tags: [cephfs, create_dirs, storage]
