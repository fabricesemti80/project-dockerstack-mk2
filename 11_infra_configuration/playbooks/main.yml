---
- name: Homelab Infrastructure Configuration
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: "Install prerequisites for repo setup"
      ansible.builtin.apt:
        name:
          - gnupg
          - curl
          - apt-transport-https
          - ca-certificates
          - acl
          - python3-pip
          - python3-packaging
        state: present
        update_cache: true
      tags: [always]

  roles:
    - role: artis3n.tailscale
      vars:
        tailscale_authkey: "{{ lookup('env', 'TAILSCALE_AUTH_KEY') }}"
        tailscale_args: "--accept-routes=false --ssh"
      ignore_errors: "{{ ansible_check_mode }}"
      tags: [tailscale]

    - role: geerlingguy.pip
      vars:
        pip_package: python3-pip
        pip_install_packages:
          - setuptools
          - pynvim
          - docker
      ignore_errors: "{{ ansible_check_mode }}"

  tasks:
    - name: "Refresh Tailscale interface facts"
      ansible.builtin.setup:
        filter: ansible_tailscale0
      tags: [always]

    - name: "Apply Docker role"
      ansible.builtin.include_role:
        name: geerlingguy.docker
      vars:
        docker_users:
          - "{{ admin_user }}"
          - "{{ secondary_user }}"
        docker_daemon_options:
          mtu: 1280
          hosts:
            - "tcp://{{ ansible_facts['ansible_tailscale0'].ipv4.address | default('127.0.0.1') }}:2376"
            - "unix:///var/run/docker.sock"
          log-driver: "json-file"
          log-opts:
            max-file: "3"
            max-size: "10m"
          storage-driver: "overlay2"
          live-restore: false
          userland-proxy: false
          default-address-pools:
            - base: "10.20.0.0/16"
              size: 24
      ignore_errors: "{{ ansible_check_mode }}"
      tags: [docker]

    - name: "Apply remaining roles"
      block:
        - ansible.builtin.import_role:
            name: fresh_install
      ignore_errors: "{{ ansible_check_mode }}"
      tags: [fresh_install]

  post_tasks:
    - name: "Final Portainer Information"
      ansible.builtin.debug:
        msg:
          - "=================================================="
          - "üöÄ PORTAINER DEPLOYMENT COMPLETE"
          - ""
          - "üåê Access URLs:"
          - "   ‚Ä¢ Public IP:    {{ hostvars[groups['cloud_vms'][0]].portainer_public_url | default('N/A') }}"
          - "   ‚Ä¢ Tailscale IP: {{ hostvars[groups['cloud_vms'][0]].portainer_tailscale_url | default('N/A') }}"
          - "   ‚Ä¢ Domain:       {{ hostvars[groups['cloud_vms'][0]].portainer_domain_url | default('N/A') }}"
          - ""
          - "üîë API Token (terraform):"
          - "   {{ hostvars[groups['cloud_vms'][0]].portainer_access_token | default('N/A') }}"
          - ""
          - "‚ö†Ô∏è Note: Store this token securely. It will not be shown again."
          - "=================================================="
      run_once: true
      when: 
        - hostvars[groups['cloud_vms'][0]].portainer_access_token is defined
        - not ansible_check_mode

  handlers:
    - name: "Reload systemd"
      ansible.builtin.systemd:
        daemon_reload: true
