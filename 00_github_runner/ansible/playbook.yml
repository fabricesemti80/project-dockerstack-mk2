---
- hosts: all
  become: true
  vars:
    runner_version: "2.321.0"
    runner_user: "runner"
    runner_dir: "/home/{{ runner_user }}/actions-runner"
    # repo_url: passed via extra vars
    # github_token: passed via extra vars (from RUNNER_TOKEN)

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install dependencies
      apt:
        name:
          - curl
          - git
          - jq
          - tar
          - unzip
          - build-essential
          - acl
          - libicu-dev
          - libssl-dev
          - apt-transport-https
          - gnupg
        state: present

    - name: Install Doppler CLI
      shell: |
        (curl -Ls https://cli.doppler.com/install.sh || wget -qO- https://cli.doppler.com/install.sh) | sh
      args:
        creates: /usr/bin/doppler

    - name: Install Ansible
      apt:
        name: ansible
        state: present

    - name: Install Task
      shell: |
        sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
      args:
        creates: /usr/local/bin/task

    - name: Install Docker
      shell: curl -fsSL https://get.docker.com | sh
      args:
        creates: /usr/bin/docker

    - name: Create runner user
      user:
        name: "{{ runner_user }}"
        groups: docker
        append: yes
        system: no
        create_home: yes
        shell: /bin/bash
        home: /home/{{ runner_user }}

    - name: Ensure home directory permissions
      file:
        path: "/home/{{ runner_user }}"
        mode: '0755'
        state: directory

    - name: Create runner directory
      file:
        path: "{{ runner_dir }}"
        state: directory
        owner: "{{ runner_user }}"
        group: "{{ runner_user }}"

    - name: Check if runner is already configured
      stat:
        path: "{{ runner_dir }}/.credentials"
      register: runner_configured

    - name: Download GitHub Runner
      get_url:
        url: "https://github.com/actions/runner/releases/download/v{{ runner_version }}/actions-runner-linux-x64-{{ runner_version }}.tar.gz"
        dest: "{{ runner_dir }}/actions-runner.tar.gz"
        owner: "{{ runner_user }}"
        group: "{{ runner_user }}"
      when: not runner_configured.stat.exists

    - name: Extract GitHub Runner
      unarchive:
        src: "{{ runner_dir }}/actions-runner.tar.gz"
        dest: "{{ runner_dir }}"
        remote_src: yes
        owner: "{{ runner_user }}"
        group: "{{ runner_user }}"
      when: not runner_configured.stat.exists

    - name: Install Runner .NET dependencies
      shell: ./bin/installdependencies.sh
      args:
        chdir: "{{ runner_dir }}"
      when: not runner_configured.stat.exists

    - name: Configure GitHub Runner
      shell: |
        ./config.sh --url {{ repo_url }} --token {{ github_token }} --unattended --replace --name {{ inventory_hostname }} --labels self-hosted,proxmox,docker
      args:
        chdir: "{{ runner_dir }}"
      become_user: "{{ runner_user }}"
      when: not runner_configured.stat.exists

    - name: Stop existing Runner service
      shell: ./svc.sh stop
      args:
        chdir: "{{ runner_dir }}"
      ignore_errors: yes

    - name: Uninstall existing Runner service
      shell: ./svc.sh uninstall
      args:
        chdir: "{{ runner_dir }}"
      ignore_errors: yes

    - name: Clean up _diag directory
      file:
        path: "{{ runner_dir }}/_diag"
        state: absent

    - name: Install Runner service
      shell: "./svc.sh install {{ runner_user }}"
      args:
        chdir: "{{ runner_dir }}"
      register: svc_install
      failed_when: svc_install.rc != 0 and "already exists" not in svc_install.stderr

    - name: Ensure recursive ownership of runner directory
      file:
        path: "{{ runner_dir }}"
        owner: "{{ runner_user }}"
        group: "{{ runner_user }}"
        recurse: yes

    - name: Start Runner service
      shell: ./svc.sh start
      args:
        chdir: "{{ runner_dir }}"

    - name: Reboot the runner to finalize setup
      reboot:
        msg: "Rebooting to finalize runner configuration"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: whoami

