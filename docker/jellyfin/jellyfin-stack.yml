# Jellyfin - Media Server (Shared CephFS Storage)
# https://jellyfin.org/

version: "3.9"

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    networks:
      - proxy
    volumes:
      # Shared CephFS persistence for all Proxmox nodes
      - type: bind
        source: /data/homelab/docker-data/jellyfin
        target: /config
      - type: bind
        source: /data/homelab/docker-data/jellyfin-cache
        target: /cache
      # Library remains on large NFS share
      - type: bind
        source: /data/media
        target: /media
        read_only: true
    ports:
      - target: 8096
        published: 8096
        protocol: tcp
        mode: ingress
    environment:
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${DOMAIN}
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '5.60' # 70% of 8 cores
          memory: 7G # 7 GB RAM cap
      placement:
        constraints:
          - node.labels.proxmox == true
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=proxy"
        - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN}`)"
        - "traefik.http.routers.jellyfin.entrypoints=websecure"
        - "traefik.http.routers.jellyfin.tls.certresolver=cloudflare"
        - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
        - "traefik.http.routers.jellyfin.middlewares=jellyfin-compress"
        - "traefik.http.middlewares.jellyfin-compress.compress=true"

        # Homepage Dashboard
        - "homepage.group=Docker Apps"
        - "homepage.name=Jellyfin"
        - "homepage.icon=jellyfin.png"
        - "homepage.href=https://jellyfin.${DOMAIN}"
        - "homepage.description=Media Server"
        - "homepage.widget.type=jellyfin"
        - "homepage.widget.url=http://jellyfin:8096"
        - "homepage.widget.key=${JELLYFIN_API_KEY}"
        - "homepage.widget.enableBlocks=true"
        # - "homepage.widget.enableNowPlaying=true"
        # - "homepage.widget.enableUser=true"
        # - "homepage.widget.enableMediaControl=false"
        # - "homepage.widget.showEpisodeNumber=true"
        # - "homepage.widget.expandOneStreamToTwoRows=false"

networks:
  proxy:
    external: true