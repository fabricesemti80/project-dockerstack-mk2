# Traefik & Whoami Setup Guide (Portainer GitOps)

This guide covers the deployment and configuration of the Traefik Ingress Controller and the `whoami` test service using Portainer's GitOps functionality.

## 1. Prerequisites

- A running Portainer instance.
- A Cloudflare account and a domain.
- A Cloudflare API Token with `Zone:DNS:Edit` and `Zone:Zone:Read` permissions.
- Docker Swarm initialized with appropriate node labels (managed via Ansible).
- The `proxy` overlay network created (managed via Terraform).

## 2. Environment Variables

The following environment variables are required for Traefik to handle SSL certificates via Cloudflare DNS-01 challenge. These should be managed via Doppler.

| Variable | Description | Example |
| :--- | :--- | :--- |
| `CF_DNS_API_TOKEN` | Cloudflare API Token (Permissions: `Zone:DNS:Edit`, `Zone:Zone:Read`) | `abc123...` |
| `ACME_EMAIL` | Email address for Let's Encrypt registration | `admin@example.com` |
| `DOMAIN` | Your base domain. Used for routing rules (e.g., `traefik.${DOMAIN}`) | `example.com` |

## 3. DNS Setup

1. **Identify the Cloud Leader IP**: Find the public IP of the `dkr-srv-0` node.
2. **Create A Records**: In Cloudflare, create A records for the services:
   - `traefik.yourdomain.com` → `[Cloud Leader IP]`
   - `whoami.yourdomain.com` → `[Cloud Leader IP]`
   - `*.yourdomain.com` → `[Cloud Leader IP]` (Optional wildcard)

## 4. Deployment via Terraform (Portainer Provider)

The stack is deployed using Terraform from the `20_app_deployment` directory.

### Stack Configuration
- **Name:** `traefik`
- **Network:** Uses the `proxy` overlay network.
- **Constraints:** Runs on the cloud manager node (`cloud=true` and `leader=true`).

## 5. Troubleshooting: "Too Many Redirects"

If you encounter an "Error: Too Many Redirects" when accessing your services via HTTPS:

### The Cause
This occurs when Cloudflare's SSL/TLS mode is set to **Flexible**. Cloudflare connects to Traefik over port 80 (HTTP), but Traefik is configured to redirect all HTTP traffic to HTTPS, creating an infinite loop.

### The Fix
1. Log in to the **Cloudflare Dashboard**.
2. Go to **SSL/TLS > Overview**.
3. Change the encryption mode to **Full (Strict)**. This ensures Cloudflare connects to Traefik via HTTPS using the Let's Encrypt certificates generated by Traefik.

## 6. Verification

### Dashboard
Visit `https://traefik.yourdomain.com` to access the Traefik dashboard.

### Load Balancing
Visit `https://whoami.yourdomain.com`. Refresh the page multiple times. 
- You should see the **Hostname** and **IP** change.
- This confirms that Traefik is successfully load balancing across the replicas.
